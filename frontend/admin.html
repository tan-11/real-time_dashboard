<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - ALPHV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div id="app" class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Admin Portal</h1>
            <button @click="logout" class="btn btn-danger">Logout</button>
        </div>

        <div v-if="token">
            <div class="card p-4 mb-4">
                <h4>{{ editMode ? 'Update Item' : 'Add New Item' }}</h4>
                <div class="row g-3">
                    <div class="col-md-3">
                        <input v-model="newItem.name" placeholder="Name" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <select v-model="newItem.shape" class="form-select">
                            <option disabled value="">Select Shape</option>
                            <option>Circle</option>
                            <option>Square</option>
                            <option>Triangle</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input v-model="newItem.color" list="colorOptions" placeholder="Color (Type to filter)"
                            class="form-control">

                        <datalist id="colorOptions">
                            <option v-for="color in availableColors" :value="color"></option>
                        </datalist>
                    </div>
                    <div class="col-md-3 d-flex gap-2">
                        <button v-if="!editMode" @click.prevent="createItem" class="btn btn-success w-100">Add
                            Item</button>

                        <button v-if="editMode" @click.prevent="updateItem" class="btn btn-warning w-50">Update</button>
                        <button v-if="editMode" @click.prevent="cancelEdit"
                            class="btn btn-secondary w-50">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="card p-4 mb-4 bg-light">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label>Search Name</label>
                        <input v-model="searchQuery" @keyup.enter="fetchItems" placeholder="Type name & press Enter..." class="form-control">
                    </div>
                    
                    <div class="col-md-3">
                        <label>Filter Shape</label>
                        <select v-model="filterShape" class="form-select">
                            <option value="">All Shapes</option>
                            <option>Circle</option>
                            <option>Square</option>
                            <option>Triangle</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label>Filter Color</label>
                        <select v-model="filterColor" class="form-select">
                            <option value="">All Colors</option>
                            <option v-for="color in availableColors" :value="color">{{ color }}</option>
                        </select>
                    </div>

                    <div class="col-md-2 d-flex gap-2 align-items-end">
                        <button @click="fetchItems" class="btn btn-primary w-50">Search</button>
                        
                        <button @click="clearFilters" class="btn btn-outline-secondary w-50">Clear</button>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h4>Existing Data</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Shape</th>
                            <th>Color</th>
                            <th>Created</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in items" :key="item.id">
                            <td>{{ item.name }}</td>
                            <td>{{ item.shape }}</td>
                            <td>{{ item.color }}</td>
                            <td><small>{{ formatDate(item.created_at) }}</small></td>
                            <td><small>{{ formatDate(item.updated_at) }}</small></td>

                            <td>
                                <button @click="editItem(item)" class="btn btn-sm btn-info me-2">Edit</button>

                                <button @click="deleteItem(item.id)" class="btn btn-sm btn-danger">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Check browser memory for token
                    token: localStorage.getItem('auth_token') || null,
                    newItem: { name: '', shape: '', color: '' },
                    items: [],

                    availableColors: [
                        "Red", "Blue", "Green", "Yellow", "Purple", "Orange",
                        "Black", "White", "Pink", "Brown", "Cyan", "Magenta"
                    ],

                    //search variables
                    searchQuery: '',
                    filterShape: '',
                    filterColor: '',

                    editMode: false, // Are we editing?
                    editingId: null  // Which ID are we editing?
                }
            },
            methods: {
                logout() {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('is_staff');
                    window.location.href = 'login.html';
                },

                async fetchItems() {
                    // Start with the base URL
                    let url = 'https://real-time-dashboard-t5gv.onrender.com/api/items/?';
                
                    // Only add the Search filter if text exists
                    if (this.searchQuery.trim() !== '') {
                        url += `search=${this.searchQuery}&`;
                    }
                    
                    // Only add Shape filter if a specific shape is selected (not empty)
                    if (this.filterShape && this.filterShape !== '') {
                        url += `shape=${this.filterShape}&`;
                    }
                    
                    // Only add Color filter if a specific color is selected
                    if (this.filterColor !== '') {
                        url += `color=${this.filterColor}&`;
                    }

                    console.log("Fetching URL:", url); // <--- Check your browser console to see the URL!

                    try {
                        const response = await fetch(url, {
                            headers: { 'Authorization': 'Token ' + this.token },
                            cache: 'no-store'
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }

                        const data = await response.json();
                        this.items = Array.isArray(data) ? data : [];
                    } catch (error) {
                        console.error("Error:", error);
                    }
                },

                clearFilters() {
                    // 1. Reset variables to empty strings
                    this.searchQuery = '';
                    this.filterShape = '';
                    this.filterColor = '';
                    
                    // 2. IMMEDIATELY fetch the list again (this will fetch all items)
                    this.fetchItems();
                },

                async createItem() {
                    // check color match
                    const matchedColor = this.availableColors.find(
                        c => c.toLowerCase() === this.newItem.color.toLowerCase()
                    );

                    //stop if not match
                    if (!matchedColor) {
                        alert(`Invalid Color: "${this.newItem.color}"\nPlease select one of: ${this.availableColors.join(', ')}`);
                        return; // Stop here
                    }

                    //correct the color string
                    this.newItem.color = matchedColor

                    const response = await fetch('https://real-time-dashboard-t5gv.onrender.com/api/items/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Token ' + this.token
                        },
                        body: JSON.stringify(this.newItem)
                    });

                    // CHECK FOR ERRORS
                    if (response.ok) {
                        this.newItem = { name: '', shape: '', color: '' };
                        this.fetchItems();
                    } else {
                        const errorData = await response.json();
                        // Alert the specific error from Django (e.g., "item with this name already exists.")
                        alert("Error: " + JSON.stringify(errorData));
                    }
                },

                async deleteItem(id) {
                    if (!confirm("Are you sure?")) return;

                    await fetch(`https://real-time-dashboard-t5gv.onrender.com/api/items/${id}/`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Token ' + this.token }
                    });
                    this.fetchItems();
                },

                editItem(item) {
                    this.editMode = true;
                    this.editingId = item.id;
                    // Copy the item data into the form inputs
                    this.newItem = {
                        name: item.name,
                        shape: item.shape,
                        color: item.color
                    };

                    // 2. Take a Snapshot (Keep this safe for comparison)
                    this.originalItem = {
                        name: item.name,
                        shape: item.shape,
                        color: item.color
                    };
                },
                async updateItem() {
                    const matchedColor = this.availableColors.find(
                        c => c.toLowerCase() === this.newItem.color.toLowerCase()
                    );

                    if (!matchedColor) {
                        alert(`Invalid Color: "${this.newItem.color}"\nPlease select one of: ${this.availableColors.join(', ')}`);
                        return; // Stop here
                    }

                    this.newItem.color = matchedColor;

                    // 2. NO CHANGE VALIDATION (The New Logic)
                    if (
                        this.newItem.name === this.originalItem.name &&
                        this.newItem.shape === this.originalItem.shape &&
                        this.newItem.color === this.originalItem.color
                    ) {
                        alert("No changes detected. Update cancelled.");
                        return; // STOP! Don't bother the server.
                    }

                    const response = await fetch(`https://real-time-dashboard-t5gv.onrender.com/api/items/${this.editingId}/`, {
                        method: 'PUT', //  UPDATE
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Token ' + this.token
                        },
                        body: JSON.stringify(this.newItem)
                    });

                    // CHECK FOR ERRORS
                    if (response.ok) {
                        this.cancelEdit();
                        this.fetchItems();
                    } else {
                        const errorData = await response.json();
                        alert("Error: " + JSON.stringify(errorData));
                    }
                },

                // 3. CANCEL (Reset form to Add Mode)
                cancelEdit() {
                    this.editMode = false;
                    this.editingId = null;
                    this.newItem = { name: '', shape: '', color: '' };
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString();
                }
            },
            // THIS RUNS AUTOMATICALLY WHEN PAGE LOADS
            mounted() {
                if (!this.token) {
                    window.location.href = 'login.html';
                    return;
                }

                // Security: Check if user is admin
                if (localStorage.getItem('is_staff') !== 'true') {
                    alert("Access Denied: You are not an admin.");
                    window.location.href = 'user.html';
                    return;
                }

                this.fetchItems();
            }
        }).mount('#app');
    </script>

</body>

</html>